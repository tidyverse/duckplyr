<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Interoperability with DuckDB and dbplyr • duckplyr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Interoperability with DuckDB and dbplyr">
<meta name="robots" content="noindex">
<script defer data-domain="duckplyr.tidyverse.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">duckplyr</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.0.99.9900</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/large.html">Large data</a></li>
    <li><a class="dropdown-item" href="../articles/prudence.html">Memory protection: controlling automatic materialization</a></li>
    <li><a class="dropdown-item" href="../articles/fallback.html">Fallback to dplyr</a></li>
    <li><a class="dropdown-item" href="../articles/limits.html">Translations</a></li>
    <li><a class="dropdown-item" href="../articles/duckdb.html">Interoperability with DuckDB and dbplyr</a></li>
    <li><a class="dropdown-item" href="../articles/developers.html">Selective use of duckplyr</a></li>
    <li><a class="dropdown-item" href="../articles/telemetry.html">Telemetry</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidyverse/duckplyr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Interoperability with DuckDB and dbplyr</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/duckplyr/blob/cran-1.0.99.9900/vignettes/duckdb.Rmd" class="external-link"><code>vignettes/duckdb.Rmd</code></a></small>
      <div class="d-none name"><code>duckdb.Rmd</code></div>
    </div>

    
    
<p>This article describes how to use the full power of DuckDB with
duckplyr. Two options are discussed: interoperability with dbplyr and
the use of DuckDB’s functions in duckplyr.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://conflicted.r-lib.org/" class="external-link">conflicted</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://duckplyr.tidyverse.org">duckplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: dplyr</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Overwriting <span style="color: #0000BB;">dplyr</span> methods with <span style="color: #0000BB;">duckplyr</span> methods.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Turn off with `duckplyr::methods_restore()`.</span></span>
<span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflict_prefer.html" class="external-link">conflict_prefer</a></span><span class="op">(</span><span class="st">"filter"</span>, <span class="st">"dplyr"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">[conflicted]</span> Will prefer <span style="color: #0000BB; font-weight: bold;">dplyr</span>::filter</span></span>
<span><span class="co">#&gt; over any other package.</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The duckplyr package is a drop-in replacement for dplyr, designed to
work with DuckDB as the backend. There is a translation layer that
converts R function calls to DuckDB functions or macros, aiming at full
compatibility with R. Many functions are translated already, and many
more are not. For functions that cannot be translated, duckplyr falls
back to the original R implementation, disrupting the DuckDB pipeline
and materializing intermediate results.</p>
<p>Furthermore, DuckDB has functions with no R equivalent. These might
be used already by code that interacts with DuckDB through dbplyr,
either making use of its passthrough feature (unknown functions are
translated to SQL verbatim), or by using the
<code>mutate(x = sql(...))</code> pattern. When working with duckplyr,
this functionality is still accessible, albeit through experimental
interfaces:</p>
<ul>
<li>
<code><a href="../reference/as_tbl.html">as_tbl()</a></code> converts a duckplyr table to a duckdb
<code>tbl</code> object</li>
<li>for a duckplyr table, the escape hatch <code>dd$fun(...)</code> can
be used to call arbitrary DuckDB functions</li>
</ul>
</div>
<div class="section level2">
<h2 id="from-duckplyr-to-dbplyr">From duckplyr to dbplyr<a class="anchor" aria-label="anchor" href="#from-duckplyr-to-dbplyr"></a>
</h2>
<p>The experimental <code><a href="../reference/as_tbl.html">as_tbl()</a></code> function, introduced in
duckplyr 1.1.0, transparently converts a duckplyr frame to a dbplyr
<code>tbl</code> object:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/duckdb_tibble.html">duckdb_tibble</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span></span>
<span><span class="va">df</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A duckplyr data frame: 1 variable</span></span></span>
<span><span class="co">#&gt;       a</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     2</span></span>
<span></span>
<span><span class="va">tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_tbl.html">as_tbl</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="va">tbl</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   table&lt;as_tbl_duckplyr_SwlKLUUEdL&gt; [?? x 1]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB v1.2.1 [unknown@Linux 6.11.0-1012-azure:R 4.5.0//tmp/Rtmprdw71U/duckplyr/duckplyr4366167a3ead.duckdb]</span></span></span>
<span><span class="co">#&gt;       a</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     2</span></span></code></pre></div>
<p>It achieves this by creating a temporary view that points to the
relational object created internally by duckplyr, in the same DBI
connection as the duckplyr object. No data is copied in this operation.
The view is discarded when the <code>tbl</code> object goes out of
scope.</p>
<p>This allows using arbitrary SQL code, either through
<code><a href="https://dplyr.tidyverse.org/reference/sql.html" class="external-link">sql()</a></code> or by relying on dbplyr’s passthrough feature.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sql.html" class="external-link">sql</a></span><span class="op">(</span><span class="st">"a + 1"</span><span class="op">)</span>, c <span class="op">=</span> <span class="fu">least_common_multiple</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> q01.*, least_common_multiple(a, b)<span style="color: #0000BB;"> AS </span>c</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> as_tbl_duckplyr_SwlKLUUEdL.*, a + 1<span style="color: #0000BB;"> AS </span>b</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> as_tbl_duckplyr_SwlKLUUEdL</span></span>
<span><span class="co">#&gt; ) q01</span></span></code></pre></div>
<p>There is no R function called <code>least_common_multiple()</code>,
it is interpreted as a SQL function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">least_common_multiple</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in least_common_multiple(2, 3): could not find function "least_common_multiple"</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sql.html" class="external-link">sql</a></span><span class="op">(</span><span class="st">"a + 1"</span><span class="op">)</span>, c <span class="op">=</span> <span class="fu">least_common_multiple</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 3]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB v1.2.1 [unknown@Linux 6.11.0-1012-azure:R 4.5.0//tmp/Rtmprdw71U/duckplyr/duckplyr4366167a3ead.duckdb]</span></span></span>
<span><span class="co">#&gt;       a     b     c</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     2     3     6</span></span></code></pre></div>
<p>To continue processing with duckplyr, use
<code><a href="../reference/duckdb_tibble.html">as_duckdb_tibble()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sql.html" class="external-link">sql</a></span><span class="op">(</span><span class="st">"a + 1"</span><span class="op">)</span>, c <span class="op">=</span> <span class="fu">least_common_multiple</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/duckdb_tibble.html">as_duckdb_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A duckplyr data frame: 3 variables</span></span></span>
<span><span class="co">#&gt;       a     b     c</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     2     3     6</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="call-arbitrary-functions-in-duckplyr">Call arbitrary functions in duckplyr<a class="anchor" aria-label="anchor" href="#call-arbitrary-functions-in-duckplyr"></a>
</h2>
<p>The escape hatch, also introduced in duckplyr 1.1.0, allows calling
arbitrary DuckDB functions directly from duckplyr, without going through
SQL:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/duckdb_tibble.html">duckdb_tibble</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">2L</span>, b <span class="op">=</span> <span class="fl">3L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>c <span class="op">=</span> <span class="va">dd</span><span class="op">$</span><span class="fu">least_common_multiple</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A duckplyr data frame: 3 variables</span></span></span>
<span><span class="co">#&gt;       a     b     c</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     2     3     6</span></span></code></pre></div>
<p>The <code>dd</code> prefix has been picked for the following
reasons:</p>
<ul>
<li>it is an abbreviation of “DuckDB”</li>
<li>it is short and easy to type</li>
<li>there is no package of this name</li>
<li>objects are not commonly named <code>dd</code> in R</li>
</ul>
<p>A prefix is necessary to avoid name clashes with existing R
functions. If this is used widely, large-scale code analysis may help
prioritize the translation of functions that are not yet supported by
duckplyr.</p>
<p>The <a href="https://github.com/cynkra/dd" class="external-link">dd package</a>, when
attached, will provide a <code>dd</code> object containing many known
DuckDB functions. This adds support for autocomplete:</p>
<div class="float">
<img src="dd.png" alt="Screenshot for autocomplete with the dd package"><div class="figcaption">Screenshot for autocomplete with the dd
package</div>
</div>
<p>This package is not necessary to use duckplyr, and the list of
functions is incomplete and growing. In case you’re wondering:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/duckdb_tibble.html">duckdb_tibble</a></span><span class="op">(</span>a <span class="op">=</span> <span class="st">"dbplyr"</span>, b <span class="op">=</span> <span class="st">"duckplyr"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>c <span class="op">=</span> <span class="va">dd</span><span class="op">$</span><span class="fu">damerau_levenshtein</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A duckplyr data frame: 3 variables</span></span></span>
<span><span class="co">#&gt;   a      b            c</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> dbplyr duckplyr     3</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>While duckplyr is designed to be a drop-in replacement for dplyr, it
still allows to harness most if not all of the power of DuckDB.</p>
<p>See <code><a href="../articles/limits.html">vignette("limits")</a></code> for limitations in the
translation employed by duckplyr, <code><a href="../articles/fallback.html">vignette("fallback")</a></code> for
more information on fallback, and <code><a href="../articles/telemetry.html">vignette("telemetry")</a></code> for
existing attempts to prioritize work on the translation layer.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hannes.muehleisen.org/" class="external-link">Hannes Mühleisen</a>, <a href="https://krlmlr.info" class="external-link">Kirill Müller</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.9000.</p>
</div>

  </div></footer>
</body>
</html>
