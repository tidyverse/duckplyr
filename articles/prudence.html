<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Memory protection: controlling automatic materialization • duckplyr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Memory protection: controlling automatic materialization">
<script defer data-domain="duckplyr.tidyverse.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">duckplyr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/large.html">Large data</a></li>
    <li><a class="dropdown-item" href="../articles/prudence.html">Memory protection: controlling automatic materialization</a></li>
    <li><a class="dropdown-item" href="../articles/fallback.html">Fallback to dplyr</a></li>
    <li><a class="dropdown-item" href="../articles/limits.html">Translations</a></li>
    <li><a class="dropdown-item" href="../articles/duckdb.html">Interoperability with DuckDB and dbplyr</a></li>
    <li><a class="dropdown-item" href="../articles/developers.html">Selective use of duckplyr</a></li>
    <li><a class="dropdown-item" href="../articles/telemetry.html">Telemetry</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidyverse/duckplyr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Memory protection: controlling automatic materialization</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/duckplyr/blob/main/vignettes/prudence.Rmd" class="external-link"><code>vignettes/prudence.Rmd</code></a></small>
      <div class="d-none name"><code>prudence.Rmd</code></div>
    </div>

    
    
<p>Unlike traditional data frames, duckplyr defers computation until
absolutely necessary, allowing DuckDB to optimize execution. This
article explains how to control the materialization of data to maintain
a seamless dplyr-like experience while remaining cautious of memory
usage.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://conflicted.r-lib.org/" class="external-link">conflicted</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflict_prefer.html" class="external-link">conflict_prefer</a></span><span class="op">(</span><span class="st">"filter"</span>, <span class="st">"dplyr"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">[conflicted]</span> Will prefer <span style="color: #0000BB; font-weight: bold;">dplyr</span>::filter</span></span>
<span><span class="co">#&gt; over any other package.</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>From a user’s perspective, data frames backed by duckplyr, with class
<code>"duckplyr_df"</code>, behave as regular data frames in almost all
respects. In particular, direct column access like <code>df$x</code>, or
retrieving the number of rows with <code><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow()</a></code>, works
identically. Conceptually, duckplyr frames are “eager”:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">duckplyr</span><span class="fu">::</span><span class="fu"><a href="../reference/duckdb_tibble.html">duckdb_tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">df</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A duckplyr data frame: 2 variables</span></span></span>
<span><span class="co">#&gt;       x     y</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2     3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3     4</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "duckplyr_df" "tbl_df"      "tbl"         "data.frame"</span></span>
<span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">y</span></span>
<span><span class="co">#&gt; [1] 2 3 4</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>Under the hood, two key differences provide improved performance and
usability:</p>
<ul>
<li>
<strong>lazy materialization</strong>: Unlike traditional data
frames, duckplyr defers computation until absolutely necessary,
i.e. lazily, allowing DuckDB to optimize execution.</li>
<li>
<strong>prudence</strong>: Automatic materialization is
controllable, as automatic materialization of large data might otherwise
inadvertently lead to memory problems.</li>
</ul>
<p>The term “prudence” is introduced here to set a clear distinction
from the concept of “laziness”, and because “control of automatic
materialization” is a mouthful.</p>
</div>
<div class="section level2">
<h2 id="eager-and-lazy-computation">Eager and lazy computation<a class="anchor" aria-label="anchor" href="#eager-and-lazy-computation"></a>
</h2>
<p>For a duckplyr frame that is the result of a dplyr operation,
accessing column data or retrieving the number of rows will trigger a
computation that is carried out by DuckDB, not dplyr. In this sense,
duckplyr frames are also “lazy”: the computation is deferred until the
last possible moment, allowing DuckDB to optimize the whole
pipeline.</p>
<div class="section level3">
<h3 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<p>This is explained in the following example that computes the mean
arrival delay for flights departing from Newark airport (EWR) by day and
month:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights</span> <span class="op">&lt;-</span> <span class="fu">duckplyr</span><span class="fu">::</span><span class="fu"><a href="../reference/flights_df.html">flights_df</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">flights_duckdb</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">duckplyr</span><span class="fu">::</span><span class="fu"><a href="../reference/duckdb_tibble.html">as_duckdb_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">mean_arr_delay_ewr</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">flights_duckdb</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">origin</span> <span class="op">==</span> <span class="st">"EWR"</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>      .by <span class="op">=</span> <span class="va">month</span>,</span>
<span>      mean_arr_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span>,</span>
<span>      min_arr_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span>,</span>
<span>      max_arr_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span>,</span>
<span>      median_arr_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span>,</span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.012   0.004   0.015</span></span></code></pre></div>
<p>Setting up the pipeline is fast, the size of the data does not affect
the setup costs. Because the computation is deferred, DuckDB can
optimize the whole pipeline, which can be seen in the output below:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_arr_delay_ewr</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">explain</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; ┌---------------------------┐</span></span>
<span><span class="co">#&gt; │         PROJECTION        │</span></span>
<span><span class="co">#&gt; │    --------------------   │</span></span>
<span><span class="co">#&gt; │           month           │</span></span>
<span><span class="co">#&gt; │       mean_arr_delay      │</span></span>
<span><span class="co">#&gt; │       min_arr_delay       │</span></span>
<span><span class="co">#&gt; │       max_arr_delay       │</span></span>
<span><span class="co">#&gt; │      median_arr_delay     │</span></span>
<span><span class="co">#&gt; │                           │</span></span>
<span><span class="co">#&gt; │        ~33677 Rows        │</span></span>
<span><span class="co">#&gt; └-------------┬-------------┘</span></span>
<span><span class="co">#&gt; ┌-------------┴-------------┐</span></span>
<span><span class="co">#&gt; │       HASH_GROUP_BY       │</span></span>
<span><span class="co">#&gt; │    --------------------   │</span></span>
<span><span class="co">#&gt; │         Groups: #0        │</span></span>
<span><span class="co">#&gt; │                           │</span></span>
<span><span class="co">#&gt; │        Aggregates:        │</span></span>
<span><span class="co">#&gt; │    sum_no_overflow(#1)    │</span></span>
<span><span class="co">#&gt; │          avg(#2)          │</span></span>
<span><span class="co">#&gt; │          min(#3)          │</span></span>
<span><span class="co">#&gt; │          max(#4)          │</span></span>
<span><span class="co">#&gt; │     quantile_cont(#5)     │</span></span>
<span><span class="co">#&gt; │                           │</span></span>
<span><span class="co">#&gt; │        ~33677 Rows        │</span></span>
<span><span class="co">#&gt; └-------------┬-------------┘</span></span>
<span><span class="co">#&gt; ┌-------------┴-------------┐</span></span>
<span><span class="co">#&gt; │         PROJECTION        │</span></span>
<span><span class="co">#&gt; │    --------------------   │</span></span>
<span><span class="co">#&gt; │           month           │</span></span>
<span><span class="co">#&gt; │ CASE  WHEN ((arr_delay IS │</span></span>
<span><span class="co">#&gt; │ NULL)) THEN (1) ELSE 0 END│</span></span>
<span><span class="co">#&gt; │         arr_delay         │</span></span>
<span><span class="co">#&gt; │         arr_delay         │</span></span>
<span><span class="co">#&gt; │         arr_delay         │</span></span>
<span><span class="co">#&gt; │         arr_delay         │</span></span>
<span><span class="co">#&gt; │                           │</span></span>
<span><span class="co">#&gt; │        ~67355 Rows        │</span></span>
<span><span class="co">#&gt; └-------------┬-------------┘</span></span>
<span><span class="co">#&gt; ┌-------------┴-------------┐</span></span>
<span><span class="co">#&gt; │         PROJECTION        │</span></span>
<span><span class="co">#&gt; │    --------------------   │</span></span>
<span><span class="co">#&gt; │             #0            │</span></span>
<span><span class="co">#&gt; │             #1            │</span></span>
<span><span class="co">#&gt; │                           │</span></span>
<span><span class="co">#&gt; │        ~67355 Rows        │</span></span>
<span><span class="co">#&gt; └-------------┬-------------┘</span></span>
<span><span class="co">#&gt; ┌-------------┴-------------┐</span></span>
<span><span class="co">#&gt; │           FILTER          │</span></span>
<span><span class="co">#&gt; │    --------------------   │</span></span>
<span><span class="co">#&gt; │ ((NOT (arr_delay IS NULL))│</span></span>
<span><span class="co">#&gt; │    AND (origin = 'EWR'))  │</span></span>
<span><span class="co">#&gt; │                           │</span></span>
<span><span class="co">#&gt; │        ~67355 Rows        │</span></span>
<span><span class="co">#&gt; └-------------┬-------------┘</span></span>
<span><span class="co">#&gt; ┌-------------┴-------------┐</span></span>
<span><span class="co">#&gt; │     R_DATAFRAME_SCAN      │</span></span>
<span><span class="co">#&gt; │    --------------------   │</span></span>
<span><span class="co">#&gt; │      Text: data.frame     │</span></span>
<span><span class="co">#&gt; │                           │</span></span>
<span><span class="co">#&gt; │        Projections:       │</span></span>
<span><span class="co">#&gt; │           month           │</span></span>
<span><span class="co">#&gt; │         arr_delay         │</span></span>
<span><span class="co">#&gt; │           origin          │</span></span>
<span><span class="co">#&gt; │                           │</span></span>
<span><span class="co">#&gt; │        ~336776 Rows       │</span></span>
<span><span class="co">#&gt; └---------------------------┘</span></span></code></pre></div>
<p>The first step in the pipeline is to prune the unneeded columns, only
<code>origin</code>, <code>month</code>, and <code>arr_delay</code> are
kept. The result becomes available when accessed:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">mean_arr_delay_ewr</span><span class="op">$</span><span class="va">mean_arr_delay</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.017   0.005   0.017</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="comparison">Comparison<a class="anchor" aria-label="anchor" href="#comparison"></a>
</h3>
<p>The functionality is similar to lazy tables in <a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a> and lazy frames in <a href="https://dtplyr.tidyverse.org/" class="external-link">dtplyr</a>. However, the behavior
is different: at the time of writing, the internal structure of a lazy
table or frame is different from a data frame, and columns cannot be
accessed directly.</p>
<table class="table">
<thead><tr class="header">
<th></th>
<th align="center">
<strong>Eager</strong> 😃</th>
<th align="center">
<strong>Lazy</strong> 😴</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>dplyr</strong></td>
<td align="center">✅</td>
<td align="center"></td>
</tr>
<tr class="even">
<td><strong>dbplyr</strong></td>
<td align="center"></td>
<td align="center">✅</td>
</tr>
<tr class="odd">
<td><strong>dtplyr</strong></td>
<td align="center"></td>
<td align="center">✅</td>
</tr>
<tr class="even">
<td><strong>duckplyr</strong></td>
<td align="center">✅</td>
<td align="center">✅</td>
</tr>
</tbody>
</table>
<p>In contrast, with <a href="https://dplyr.tidyverse.org/" class="external-link">dplyr</a>,
each intermediate step and also the final result is a proper data frame,
and computed right away, forfeiting the opportunity for
optimization:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">origin</span> <span class="op">==</span> <span class="st">"EWR"</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>      .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">month</span>, <span class="va">day</span><span class="op">)</span>,</span>
<span>      mean_arr_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span>,</span>
<span>      min_arr_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span>,</span>
<span>      max_arr_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span>,</span>
<span>      median_arr_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span>,</span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.037   0.007   0.044</span></span></code></pre></div>
<p>See also the <a href="https://duckdb.org/2024/04/02/duckplyr.html" class="external-link">duckplyr: dplyr
Powered by DuckDB</a> blog post for more information.</p>
</div>
</div>
<div class="section level2">
<h2 id="prudence">Prudence<a class="anchor" aria-label="anchor" href="#prudence"></a>
</h2>
<p>Being both “eager” and “lazy” at the same time introduces a
challenge: it is too easy to accidentally trigger computation, which is
prohibitive if an intermediate result is too large to fit into memory.
Prudence is a setting for duckplyr frames that limits the size of the
data that is materialized automatically.</p>
<div class="section level3">
<h3 id="concept">Concept<a class="anchor" aria-label="anchor" href="#concept"></a>
</h3>
<p>Three levels of prudence are available:</p>
<ul>
<li>
<em>lavish</em> (careless about resources): always automatically
materialize, as in the first example.</li>
<li>
<em>stingy</em> (avoid spending at all cost): never automatically
materialize, throw an error when attempting to access the data.</li>
<li>
<em>thrifty</em> (use resources wisely): only automaticaly
materialize the data if it is small, otherwise throw an error.</li>
</ul>
<p>For lavish duckplyr frames, as in the two previous examples, the
underlying DuckDB computation is carried out upon the first request.
Once the results are computed, they are cached and subsequent requests
are fast. This is a good choice for small to medium-sized data, where
DuckDB can provide a nice speedup but materializing the data is
affordable at any stage. This is the default for
<code><a href="../reference/duckdb_tibble.html">duckdb_tibble()</a></code> and <code><a href="../reference/duckdb_tibble.html">as_duckdb_tibble()</a></code>.</p>
<p>For stingy duckplyr frames, accessing a column or requesting the
number of rows triggers an error. This is a good choice for large data
sets where the cost of materializing the data may be prohibitive due to
size or computation time, and the user wants to control when the
computation is carried out and where the results are stored. Results can
be materialized explicitly with <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> and other
functions.</p>
<p>Thrifty duckplyr frames are a compromise between lavish and stingy,
discussed further below.</p>
</div>
<div class="section level3">
<h3 id="example-1">Example<a class="anchor" aria-label="anchor" href="#example-1"></a>
</h3>
<p>Passing <code>prudence = "stingy"</code> to
<code><a href="../reference/duckdb_tibble.html">as_duckdb_tibble()</a></code> creates a stingy duckplyr frame.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights_stingy</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">duckplyr</span><span class="fu">::</span><span class="fu"><a href="../reference/duckdb_tibble.html">as_duckdb_tibble</a></span><span class="op">(</span>prudence <span class="op">=</span> <span class="st">"stingy"</span><span class="op">)</span></span></code></pre></div>
<p>The data can be displayed, and column names and types can be
accessed.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights_stingy</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A duckplyr data frame: 19 variables</span></span></span>
<span><span class="co">#&gt;     year month   day dep_time sched_dep_time dep_delay arr_time</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  <span style="text-decoration: underline;">2</span>013     1     1      517            515         2      830</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  <span style="text-decoration: underline;">2</span>013     1     1      533            529         4      850</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  <span style="text-decoration: underline;">2</span>013     1     1      542            540         2      923</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  <span style="text-decoration: underline;">2</span>013     1     1      544            545        -<span style="color: #BB0000;">1</span>     <span style="text-decoration: underline;">1</span>004</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  <span style="text-decoration: underline;">2</span>013     1     1      554            600        -<span style="color: #BB0000;">6</span>      812</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  <span style="text-decoration: underline;">2</span>013     1     1      554            558        -<span style="color: #BB0000;">4</span>      740</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  <span style="text-decoration: underline;">2</span>013     1     1      555            600        -<span style="color: #BB0000;">5</span>      913</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  <span style="text-decoration: underline;">2</span>013     1     1      557            600        -<span style="color: #BB0000;">3</span>      709</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  <span style="text-decoration: underline;">2</span>013     1     1      557            600        -<span style="color: #BB0000;">3</span>      838</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  <span style="text-decoration: underline;">2</span>013     1     1      558            600        -<span style="color: #BB0000;">2</span>      753</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 12 more variables: sched_arr_time &lt;int&gt;, arr_delay &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">flights_stingy</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span>
<span><span class="co">#&gt;  [1] "year"           "month"          "day"           </span></span>
<span><span class="co">#&gt;  [4] "dep_time"       "sched_dep_time" "dep_delay"     </span></span>
<span><span class="co">#&gt;  [7] "arr_time"       "sched_arr_time" "arr_delay"     </span></span>
<span><span class="co">#&gt; [10] "carrier"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">flights_stingy</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "prudent_duckplyr_df" "duckplyr_df"         "tbl_df"             </span></span>
<span><span class="co">#&gt; [4] "tbl"                 "data.frame"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">flights_stingy</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "integer"</span></span></code></pre></div>
<p>On the other hand, accessing a column or requesting the number of
rows triggers an error:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">flights_stingy</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Materialization is disabled, use collect() or as_tibble() to materialize.</span></span>
<span></span>
<span><span class="va">flights_stingy</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; Error: Materialization is disabled, use collect() or as_tibble() to materialize.</span></span></code></pre></div>
<p>This means that stingy duckplyr frames can also be used to enforce
DuckDB operation for a pipeline.</p>
</div>
<div class="section level3">
<h3 id="enforcing-duckdb-operation">Enforcing DuckDB operation<a class="anchor" aria-label="anchor" href="#enforcing-duckdb-operation"></a>
</h3>
<p>For operations not supported by duckplyr, the original dplyr
implementation is used as a fallback. As the original dplyr
implementation accesses columns directly, the data must be materialized
before a fallback can be executed. Therefore, stingy frames allow you to
check that all operations are supported by DuckDB: for a stingy frame,
fallbacks to dplyr are not possible.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights_stingy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">origin</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `group_by()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> This operation cannot be carried out by DuckDB, and the input</span></span>
<span><span class="co">#&gt;   is a stingy duckplyr frame.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Try `summarise(.by = ...)` or `mutate(.by = ...)` instead of</span></span>
<span><span class="co">#&gt;   `group_by()` and `ungroup()`.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use `compute(prudence = "lavish")` to materialize to temporary</span></span>
<span><span class="co">#&gt;   storage and continue with <span style="color: #0000BB;">duckplyr</span>.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> See `vignette("prudence")` for other options.</span></span></code></pre></div>
<p>The same pipeline with a lavish frame works, but the computation is
carried out by dplyr:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights_stingy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">duckplyr</span><span class="fu">::</span><span class="fu"><a href="../reference/duckdb_tibble.html">as_duckdb_tibble</a></span><span class="op">(</span>prudence <span class="op">=</span> <span class="st">"lavish"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">origin</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">#&gt;   origin      n</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> EWR    <span style="text-decoration: underline;">120</span>835</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> JFK    <span style="text-decoration: underline;">111</span>279</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> LGA    <span style="text-decoration: underline;">104</span>662</span></span></code></pre></div>
<p>By using operations supported by duckplyr and avoiding fallbacks as
much as possible, your pipelines will be executed by DuckDB in an
optimized way.</p>
</div>
<div class="section level3">
<h3 id="from-stingy-to-lavish">From stingy to lavish<a class="anchor" aria-label="anchor" href="#from-stingy-to-lavish"></a>
</h3>
<p>A stingy duckplyr frame can be converted to a lavish one with
<code>as_duckdb_tibble(prudence = "lavish")</code>. The
<code><a href="../reference/collect.duckplyr_df.html">collect.duckplyr_df()</a></code> method triggers computation and
converts to a plain tibble. The difference between the two is the class
of the returned object:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights_stingy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">duckplyr</span><span class="fu">::</span><span class="fu"><a href="../reference/duckdb_tibble.html">as_duckdb_tibble</a></span><span class="op">(</span>prudence <span class="op">=</span> <span class="st">"lavish"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "duckplyr_df" "tbl_df"      "tbl"         "data.frame"</span></span>
<span></span>
<span><span class="va">flights_stingy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "tbl_df"     "tbl"        "data.frame"</span></span></code></pre></div>
<p>The same behavior is achieved with <code><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble()</a></code> and
<code><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame()</a></code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights_stingy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "tbl_df"     "tbl"        "data.frame"</span></span>
<span></span>
<span><span class="va">flights_stingy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "data.frame"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="comparison-1">Comparison<a class="anchor" aria-label="anchor" href="#comparison-1"></a>
</h3>
<p>Stingy duckplyr frames behave like lazy tables in dbplyr and lazy
frames in dtplyr: the computation only starts when you
<em>explicitly</em> request it with <code><a href="../reference/collect.duckplyr_df.html">collect.duckplyr_df()</a></code>
or through other means. However, stingy duckplyr frames can be converted
to lavish ones at any time, and vice versa. In dtplyr and dbplyr, there
are no lavish frames: collection always needs to be explicit.</p>
</div>
</div>
<div class="section level2">
<h2 id="thrift">Thrift<a class="anchor" aria-label="anchor" href="#thrift"></a>
</h2>
<p>Thrifty is a compromise between stingy and lavish. Materialization is
allowed for data up to a certain size, measured in cells (values) and
rows in the resulting data frame.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">flights</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 336776</span></span>
<span><span class="va">flights_partial</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">duckplyr</span><span class="fu">::</span><span class="fu"><a href="../reference/duckdb_tibble.html">as_duckdb_tibble</a></span><span class="op">(</span>prudence <span class="op">=</span> <span class="st">"thrifty"</span><span class="op">)</span></span></code></pre></div>
<p>With this setting, the data is materialized only if the result has
fewer than 1,000,000 cells (rows multiplied by columns).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights_partial</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">origin</span>, <span class="va">dest</span>, <span class="va">dep_delay</span>, <span class="va">arr_delay</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Materialization would result in more than 250000 rows. Use collect() or as_tibble() to materialize.</span></span></code></pre></div>
<p>The original input is too large to be materialized, so the operation
fails. On the other hand, the result after aggregation is small enough
to be materialized:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights_partial</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">origin</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>Thrifty is a good choice for data sets where the cost of
materializing the data is prohibitive only for large results. This is
the default for the ingestion functions like
<code><a href="../reference/read_parquet_duckdb.html">read_parquet_duckdb()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>The duckplyr package provides</p>
<ul>
<li>a drop-in replacement for duckplyr, which necessitates “eager” data
frames that automatically materialize like in dplyr,</li>
<li>optimization by DuckDB, which means “lazy” evaluation where the data
is materialized at the latest possible stage.</li>
</ul>
<p>Automatic materialization can be dangerous for memory with large
data, so duckplyr provides a setting called <code>prudence</code> that
controls automatic materialization: is the data automatically
materialized <em>always</em> (“lavish” frames), <em>never</em> (“stingy”
frames) or <em>up to a certain size</em> (“thrifty” frames).</p>
<p>See <code><a href="../articles/large.html">vignette("large")</a></code> for more details on working with
large data sets, <code><a href="../articles/fallback.html">vignette("fallback")</a></code> for fallbacks to
dplyr, <code><a href="../articles/limits.html">vignette("limits")</a></code> for the operations supported by
duckplyr, and <code><a href="../articles/duckdb.html">vignette("duckdb")</a></code> for using DuckDB functions
directly.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hannes.muehleisen.org/" class="external-link">Hannes Mühleisen</a>, <a href="https://krlmlr.info" class="external-link">Kirill Müller</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.9000.</p>
</div>

  </div></footer>
</body>
</html>
